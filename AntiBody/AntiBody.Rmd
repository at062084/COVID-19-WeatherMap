---
title: "COVID-19: Impfung und Antikörper Messung"
subtitle: "http://cwm.rshiny.world"
author: Thomas Strehl  https://www.linkedin.com/in/strehl-thomas-122867110
date: "2022-07-01"
output:
  pdf_document:
    fig_height: 6
    fig_width: 8
    number_sections: yes
    toc: yes
    toc_depth: 2
geometry: margin=1cm
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.align="center")
library(ggplot2)
library(dplyr)
library(tidyr)
```

\newpage
# COVID-19: Impfungen und Messung der Antikörper

Dieses Dokument beschreibt anhand zweier Testpersonen den zeitlichen Verlauf der COVID-19 Impfungen und die Ergebnisse einer Reihe von IgG Antikörper Tests. Die Daten umfassen

- Zeitreihen von 2 Pesonen (M, W, beide Altersgruppe 55-65)
- Je zwei Impfungen (Serie1: W=AstraZeneca, Serie 2: M=BiontecPfizer)
- Mehrmalige Messung der Antikörper (Einheit BAU/ml, IgG, einschl. neutralisierende AK gegen Spike RBD der S1-Untereinheit des Spike-Proteins von SARS-CoV-2, durchgeführt bei SYNLAB/IMCL)



```{r}
df <- read.csv("AntiBody.csv")
df$Datum <- as.POSIXct(as.character(df$Datum))
df$ID <- factor(df$ID)

# Exctract date for 'ZweiteImpfung
di <- df %>% dplyr::filter(ImpfStatus=="ZweiteImpfung", Aktion=="Impfung") %>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(DatumZweiteImpfung=Datum) %>%
  dplyr::select(ID, DatumZweiteImpfung)

# Calculate new TimeScale based on DatumZwiteImpfung 
df <- df %>%
  dplyr::left_join(di) %>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(Monat = as.numeric((Datum-DatumZweiteImpfung)/3600/24/30)) %>%
  dplyr::ungroup()

```


```{r}
# Regression Models
Monat=seq(0,24,by=.1)

ds1_2 <- df %>% dplyr::filter(ID==1, ImpfStoff=="BiontecPfizer", ImpfStatus=="ZweiteImpfung", Aktion=="AntiKörper")
lm1_2 <- lm(formula=log2(Wert)~Monat, data=ds1_2)
pred1_2 <- 2^predict(lm1_2, newdata=data.frame(Monat=Monat))
dp1_2 <- data.frame(Geschlecht="M", Monat=Monat, Wert=pred1_2, ImpfStoff="BiontecPfizer")


ds1_3 <- df %>% dplyr::filter(ID==1, ImpfStoff=="BiontecPfizer", ImpfStatus=="DritteImpfung", Aktion=="AntiKörper", Datum>as.POSIXct("2021-12-01"))
lm1_3 <- lm(formula=log2(Wert)~Monat, data=ds1_3)
pred1_3 <- 2^predict(lm1_3, newdata=data.frame(Monat=Monat))
dp1_3 <- data.frame(Geschlecht="M", Monat=Monat, Wert=pred1_3, ImpfStoff="BiontecPfizer")

```


```{r}
ds2_2 <- df %>% dplyr::filter(ID==2, ImpfStoff=="AstraZeneca", ImpfStatus=="ZweiteImpfung", Aktion=="AntiKörper")
lm2_2 <- lm(formula=log2(Wert)~Monat, data=ds2_2)
pred2_2 <- 2^predict(lm2_2, newdata=data.frame(Monat=Monat))
dp2_2 <- data.frame(Geschlecht="W", Monat=Monat, Wert=pred2_2, ImpfStoff="AstraZeneca")
```

```{r}
ds2_3 <- df %>% dplyr::filter(ID==2, ImpfStoff=="BiontecPfizer", ImpfStatus=="DritteImpfung", Aktion=="AntiKörper", Datum>as.POSIXct("2021-12-01"))
lm2_3 <- lm(formula=log2(Wert)~Monat, data=ds2_3)
pred2_3 <- 2^predict(lm2_3, newdata=data.frame(Monat=Monat))
dp2_3 <- data.frame(Geschlecht="W", Monat=Monat, Wert=pred2_3, ImpfStoff="BiontecPfizer")
```


## Zeitlicher Verlauf der Impfungen und Antikörper Werte

In der folgenden Darstellung sind die Zeitreihen der Antikörper Messungen der beiden Testpersonen dargestellt. 

- Die Zeitachsen der beiden Verläufe sind auf den Zeitpunkt der zweiten Impfung syncronisiert
- Zeitpunkte vor der zweiten Impfung haben negative Werte
- Die Einheit der Werte auf der y-Achse sind BAU/ml
- Die maximal erreichten Werte liegen bei Testperson W mit AstraZeneca bei 550
- Die maximal erreichten Werte liegen bei Testperson M mit BiontecPfizer bei 1800

In beiden Fällen nehmen die Werte mit der Zeit in etwa exponentiell ab (Mit den Daten der TestPerson W mit AstraZeneca wäre statt des exponentiellen auch ein linears Modell verträglich; ein zerfallsprozessartigen Vorgang kann aber nicht durch ein lineares Modell modelliert werden)

```{r}
ggplot(data=df %>% dplyr::filter(Aktion=="AntiKörper"), aes(x=Monat, y=Wert, shape=ImpfStoff, color=ImpfStatus, group=ImpfStatus)) +
  scale_x_continuous(limit=c(-3.1,15), breaks=-3:15, sec.axis=dup_axis()) +
  scale_y_continuous(limit=c(-50,6000), breaks=seq(0,6000,by=500), sec.axis=dup_axis(), expand=c(0.0,0.0)) +
  geom_vline(data=df %>% dplyr::filter(Aktion=="Impfung"), aes(xintercept=Monat, color=ImpfStatus), size=1.5) +
  geom_line(size=1) +
  facet_grid(Geschlecht~.) +
  geom_line(data=dp1_2, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  geom_line(data=dp1_3, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  geom_line(data=dp2_2, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=2) +
  geom_line(data=dp2_3, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=2) +
  geom_point(size=3, color="black") + 
  ggtitle("Vacination and AntiBody Test results: 2 Samples (AgeGroup 55-65, M and W), \nExponential Model, BAU/ml units")
```
\newpage
## Exponentielle Abnahme der Antiköper Werte

Die These einer exponentiellen Abnahme der Antikörper Messwerte mit der Zeit lässt sich durch eine logarithmische Darstellung verifizieren. 

- In dieser Darstellung sollten die Werte linear abnehmen, d.h. auf einer Geraden liegen
- Die Beschriftung der y-Achse ist so gewählt, dass jede Skalenstufe eine Verdoppelung bzw. Halbierung der Antikörper Messwerte anzeigt

Die Halbwertszeit, d.h. die Dauer bis zu einer Halbierung der Messwerte,  ist

- 70 Tage (2.4 Monate) für TestPerson W mit AstraZeneca
- 35 Tage (1.2 Monate) für TestPerson M mit BiontecPfizer

Trotz wesentlich höherer Maximalwerte werden bei Testperson M mit BiontecPfizer die Antikörper bereits nach ca. 10 Monaten vermutlich nicht mehr nachweisbar sein. Bei TestPerson W mit AstraZeneca sind die maximalen Antikörperwerte vergleichsweise niedrig, nehmen aber wesentlich langsamer ab, sodass der Nachweis vermutlich erst nach über einem Jahr nicht mehr möglich sein wird.

**Anmerkung:** Die Prognosen für die Antikörper Werte sind bestenfalls erste Anhaltspunkte und müssen durch fortgesetzte Messungen an den beiden (sowie weiteren) Testpersonen präzisiert werden.


```{r}
ggplot(data=df %>% dplyr::filter(Aktion=="AntiKörper"), aes(x=Monat, y=Wert, shape=ImpfStoff, color=ImpfStatus, group=ImpfStatus)) +
  scale_x_continuous(limit=c(-3.1,15), breaks=-3:15, sec.axis=dup_axis()) +
  scale_y_continuous(limit=c(10,6000), breaks=2^seq(0:15), sec.axis=dup_axis(), trans="log2") +
  geom_vline(data=df %>% dplyr::filter(Aktion!="AntiKörper"), aes(xintercept=Monat, color=ImpfStatus), size=1.5) +
  geom_line() +
  facet_grid(Geschlecht~.) +
  geom_line(data=dp1_2, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  geom_line(data=dp1_3, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  geom_line(data=dp2_2, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=2) +
  geom_line(data=dp2_3, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=2) +
  geom_point(size=3, color="black") + 
  ggtitle("Vacination and AntiBody Test results: 2 Samples (AgeGroup 55-65, M and W), \nExponential Model, logScale y, BAU/ml units for half/double")
```




\newpage
# Technische Details

## DatenStruktur

```{r}
str(df)
```

## Daten

```{r}
df %>% select(ID, Alter, Geschlecht, Datum, ImpfStatus, ImpfStoff, Aktion, Wert) %>% print(n=100)
```

\newpage
## Exponentielles Modell und Halbwertszeit der BAU

Halbwertszeit der BAU Werte in Monaten

### TestPerson M, 62J

Zweite Impfung
```{r}
summary(lm1_2)
(HalbwertsZeit = -1/coef(lm1_2)[2])

```

Dritte Impfung

```{r}
summary(lm1_3)
(HalbwertsZeit = -1/coef(lm1_3)[2])

```

\newpage
### TestPerson W, 56J

Zweite Impfung
```{r}
summary(lm2_2)
(HalbwertsZeit = -1/coef(lm2_2)[2])

```

Dritte Impfung

```{r}
summary(lm2_3)
(HalbwertsZeit = -1/coef(lm2_3)[2])

```




