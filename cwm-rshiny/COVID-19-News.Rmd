---
title: "Aktuelles"
date: "2021-09-01"
output:
  html_document:
    df_print: kable
    fig_caption: no
    fig_height: 6
    fig_width: 9
    number_sections: no
    toc: yes
    toc_depth: 3
  always_allow_html: true
  pdf_document:
    toc: yes
    toc_depth: '3'
    fig_height: 4
    fig_width: 7
geometry: margin=1cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
#knitr::opts_chunk$set(fig.align="center")
#options(knitr.table.format = 'html')
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(forcats)
library(knitr)
library(gt)
library(pivottabler)
library(kableExtra)
library(zoo)
```

```{r}
source("cwm-data.R")
source("cwm-util.R")
#cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#444444", "#F0D042", "#0072B2", "#D55E00", "#CC79A7", "#C40000")

cbPalette <- c("#AAAAAA", "#E69F00", "#56B4E9", "#009E73", "#666666", "#F0D042", "#0072B2", "#D55E00", "#CC79A7", "#C40000")
atShapes <- c(10,6,7,2,11,5,12,22,1,9)

rollMeanDays <- 7
#leadDaysRecovered <- 18
#leadDaysDeath <- 14
lagDaysVaccinated_1 <- 21
lagDaysVaccinated_2 <- 14

# Optimized heuristically for AgeGroups 65-84 (most populated endagered groups)
leadDaysRecovered=21
leadDaysDeath=20

asyptomaticCorrectionFactor = 2
vaccinationImmunizationFaktor = 0.9

```



```{r, results='hide'}
### Confirmed, Recovered, Death ab 2020-02-26
# CovidFaell_Altersgruppe.csv aus AGES zip
# --> obsoletes CovidFaelle_Timeline.csv (same time frame, but Bundesland only)
dcrd <- caAgesData_crd_rag(rollMeanDays=rollMeanDays)
str(dcrd)
```  

```{r, results='hide'}
### Vaccinated ab 2020-12-27
# https://info.gesundheitsministerium.gv.at/data/timeline-eimpfpass.csv
dv <- caBmsgpkData_v_rag(rollMeanDays=rollMeanDays)
str(dv)
``` 


```{r, results='hide'}
### Datensatz nach Bundesland, Altersgruppe und Geschlecht: Confirmed, Recovered, Death, Vaccinated

dcrdv <- dcrd %>%
  dplyr::left_join(dv, by=c("Date","RegionID","Region","AgeGroup","AgeGroup3","Gender")) %>%
  dplyr::select(Date, Region, RegionID, AgeGroup, AgeGroupID, AgeGroup3, AgeGroup2, Gender, Population, starts_with("new"), starts_with("sum")) %>%
  dplyr::mutate(Gender=factor(Gender))

idx <- is.na(dcrdv$newVaccinated_1)
dcrdv$newVaccinated_1[idx] <- 0
idx <- is.na(dcrdv$sumVaccinated_1)
dcrdv$sumVaccinated_1[idx] <- 0

idx <- is.na(dcrdv$newVaccinated_2)
dcrdv$newVaccinated_2[idx] <- 0
idx <- is.na(dcrdv$sumVaccinated_2)
dcrdv$sumVaccinated_2[idx] <- 0

str(dcrdv)
```  

```{r, results='hide'}
## Bundesland
### Confirmed, Recovered, Death, Inzidenz seit 2020-02-26
# CovidFaelle_Timeline.csv aus AGES zip
bcrdz <- caAgesData_crd_r(rollMeanDays=7)
str(bcrdz)
```

```{r, results='hide'}
### Tested, Hospital, ICU seit 2020-04-01
# CovidFallzahlen.csv aus AGES zip
bthi <- caAgesData_thi_r(rollMeanDays=7)
str(bthi)
```

```{r, results='hide'}
### Datensatz nach Bundesland: Confirmed, Recovered, Death, Inzidenz, Tested, Hospital, ICU
# Merge bcrdz and bthi
btcrdzhi <- bcrdz %>%
  dplyr::left_join(bthi, by=c("Date","Region")) %>%
  dplyr::select(Date, Region, Population, starts_with("new"), starts_with("cur") , starts_with("sum"))
str(btcrdzhi)
```


```{r, results='hide'}
### Hospital, ICU seit 2021-01-24. Redundant, not required
# Hospitalisierung.csv aus AGES zip (OpenData: https://covid19-dashboard.ages.at/data/Hospitalisierung.csv)
# --> gleiche Daten sollten in CovidFallzahlen.csv aber schon mit 2020-04-01 vorhanden sein
#hi <- caAgesData_hi_r(rollMeanDays=7)
#str(hi)
```


```{r, results='hide'}
## AgeGroup3 
### Inzidenz mit Immunization Status ab 2021-06-01
# Read new data from bmsgpk website
az3 <- caAgesData_z_a3()
str(az3)
``` 

```{r, results='hide'}
### Join mit btcrdzhi
# Flatten AgeGroup3 and ImmuStatus for join with btcrdzhi
bz3 <- az3 %>%
  tidyr::pivot_wider(names_from="AgeGroup3", values_from=c("newInzImmuYes","newInzImmuNo"))

btcrdzhi3 <- btcrdzhi %>%
  dplyr::filter(Region=="Österreich") %>%
  dplyr::select(-Region) %>%
  dplyr::left_join(bz3, by="Date")

str(btcrdzhi3)
```


Die Auswirkung der Impfungen auf das epidemiologische Geschehen wird hier anhand einiger Indizien dargestellt 

- Unterscheidung der Anzahl der neu Infizierten (positiv Getesteten) anhand des Impfstatus (vollständig bzw. nicht vollständig geimpft)
- Vergleich des Verlaufes der 4. Welle ab Juli 2021 mit der 2. Welle ab Anfang August 2020 hinsichtlich Belegung von Spitalsbetten, Intensivstationen und Sterbefälle
- Abschätzung des verbleibenden exponierten Anteils in der Bevölkerung (d.h. weder genesen noch geimpft) und Abschätzung der zu erwartenden Todesfälle (in Arbeit)

# Inzidenz nach ImpfStatus

Dazu hat die AGES Ende August einen Datensatz veröffentlicht, der die Inzidenz in drei Altersgruppen (12-18, 18-60, 60+) nach dem Impfstatus (vollständig = 2.Impfung vor mindestens 2 Wochen, nicht vollständig alle anderen) gliedert.

- Bei den Erwachsenen und bei den Senioren ist die Inzidenz der Nichtgeimpften etwa einen Faktor 6 höher als bei den vollständig Geimpften
- Bei den Jugendlichen erlaubt die Datenlage noch keine belastbare Aussage

Die Berechnung der Inzidenzwerte durch die AGES ist nicht eindeutig dokumentiert, die Werte daher nicht zweifelsfrei interpretierbar. Insbesondere ist nicht festgehalten wie die Genesenen in der Berechnung behandelt werden. Sollte die Inzidenz durch Normierung der Fallzahlen auf 100.000 pro Altersgruppe und Impfstatusgruppe erfolgt sein, dann ist auffällig:

- Die Anzahl der Infektionen bei den Senioren ist ca. einen Faktor 3 niedriger als bei den Erwachsenen. Das wäre nur erklärbar, wenn die Ansteckbaren Senioren schon durch nicht vollständige Immunisierung oder Genesung zumindest teilgeschützt sind.

```{r, results='hide'}

str(btcrdzhi3)
dp <- btcrdzhi3 %>% 
  dplyr::filter(Date > as.POSIXct("2021-06-01")) %>%
  dplyr::mutate(newConfPop100k=newConfirmed/Population*100000) %>%
  tidyr::pivot_longer(cols=c( "newInzImmuNo_Jugendliche", "newInzImmuNo_Erwachsene","newInzImmuNo_Senioren", 
                             "newInzImmuYes_Jugendliche", "newInzImmuYes_Erwachsene","newInzImmuYes_Senioren"), 
                      names_to=c("ImmuYesNo","AgeGroup3"), values_to="Anzahl", names_sep="_") %>%
  dplyr::mutate(AgeGroup3=factor(AgeGroup3, levels=c("Jugendliche", "Erwachsene", "Senioren"), labels=c("Jugendliche", "Erwachsene", "Senioren")))

dp$Anzahl[dp$Anzahl==0] <- NA

ggplot(data=dp, aes(x=Date, y=Anzahl, shape=ImmuYesNo, color=ImmuYesNo)) +
  # scale_y_continuous( sec.axis=dup_axis(), trans="log2", breaks=2^(seq(-4,10,by=1)), labels=sprintf("%g",2^(seq(-4,10,by=1)))) ) +
  scale_x_datetime(date_breaks="months", date_labels="%b") +
  scale_y_continuous(name="Inzidenz", trans="log2", 
                     breaks=2^(seq(-4,10,by=1)), labels=sprintf("%g",2^(seq(-4,10,by=1))), 
                     sec.axis=dup_axis(name="Inzidenz_Stufe = log2(Inzidenz)", labels=seq(-4,10,by=1))) +
  #scale_fill_manual(values=cbPalette) +
  #scale_color_manual(values=cbPalette) +
  geom_point(size=2) + 
  geom_line() +
  facet_grid(.~AgeGroup3) +
  ggtitle("COVID-19 Österreich: Inzidenz nach Altersgruppe und ImpfStatus. Stand: 2021-08-28")

``` 



# Vergleich 2. Welle und 4. Welle

Die 2. Welle hat sich im Verlauf von drei Monaten von Anfang August 2020 bis Ende Oktober 2020 aufgebaut.

- Die Fallzahlen haben sich in diesen grob 13 Wochen um etwa den Faktor 80 erhöht, das entspricht einer Verdoppelung alle 2 Wochen 
- Die täglichen Fallzahlen sind grob von 100 auf 8000 gestiegen, entsprechend Inzidenz gerundet 1 bis 80

Die 4. Welle breitet sich aktuell mit einer ähnlichen Geschwindigkeit aus, hat aber Ende August bereits den Stand der 2. Welle von Anfang Oktober erreicht

- Die 4. Welle ist, bezogen auf das Kalenderjahr, um etwa 6 Wochen früher als die 2. Welle

## Absolute Zahlen 

Zunächst die absoluten Zahlen (wie üblich mit log2 Skalierung in Verdoppelungsstufen). 

- Die 2. Welle ist im Zeitbereich von Aug. - Dez. 2020 dargestellt
- Die 4. Welle ist auf der Zeitachse so verschoben, dass der Anfang der beiden Wellen in etwa zusammenfällt


```{r, results='hide'}
daysDiff42 <- 333
# str(btcrdzhi3)

selCols=c("newConfirmed", "curHospital", "curICU", "newDeath")
dp <- btcrdzhi3 %>% 
  dplyr::select(c(Date, selCols)) %>%
  tidyr::pivot_longer(cols=selCols, 
                      names_to="Parameter", values_to="Anzahl") %>%
  dplyr::mutate(Parameter = factor(Parameter, levels=selCols, labels=selCols, ordered=TRUE))%>%
  dplyr::rename(Wave2=Date) %>%
  dplyr::mutate(Wave4=Wave2-days(daysDiff42)) %>%
  tidyr::pivot_longer(cols=c(Wave2, Wave4), values_to="Date", names_to="Wave")
 #str(dp)

ggplot(data=dp, aes(x=Date, y=Anzahl, color=Wave)) +
  scale_x_datetime(name="2. Welle 8/2020", limits=c(as.POSIXct("2020-08-01"),as.POSIXct("2020-12-15")),  date_breaks="months", date_labels="%b",
                   sec.axis=sec_axis(name="4. Welle 7/2021", trans = (~ . +hms::hms(days=daysDiff42)))) +
  scale_y_continuous(name="Anzahl", trans="log2", breaks=2^(seq(0,15,by=1)),
                     sec.axis=dup_axis(name="Anzahl_Stufe = log2(Anzahl)", labels=seq(0,15,by=1))) +
  geom_line(size=1) +
  facet_wrap(Parameter~., nrow=1) +
  ggtitle("COVID-19 Österreich: Vergleich 2. und 4. Welle mittels Überlagerung von Absolut Werten (Pos, Hosp, ICU, Verst)")

``` 


## Werte relativ zum Maximum der 2. Welle 

Um die Dynamik der epidemiologischen Parameter der 2. und 4. Welle besser vergleichen zu können sind hier die Fallzahlen als Prozentsatz des jeweiligen Maximums am Höhepunkt der 2. Welle dargestellt (1=100%)

- Die beiden Wellen sehen auch aus dieser Persprektive sehr ähnlich aus
- Aus aktueller Sicht gibt es keinen Grund anzunehmen, dass sich dieses Verhalten ändern wird
- Damit steuert auch die Belegung der Spitalsbetten und der Intensivstationen auf Werte wie bei der 2. Welle zu
- Die Intensivstationen sind aktuell zu 1/8 ausgelastet. Bei Verdoppelung alle 2 Wochen ist in 6 Wochen, d.h. Mitte Oktober, der Maximalstand der 2. Welle erreicht.

Ein Abschätzung der Anzahl zu erwartenden Todesfälle folgt in Kürze.



```{r, results='hide'}

# str(btcrdzhi3)

selCols=c("newConfirmed", "curHospital", "curICU", "newDeath")
dp <- btcrdzhi3 %>% 
  dplyr::select(c(Date, selCols)) %>%
  dplyr::mutate(across(.cols=selCols, .fns= ~ .x/max(.x, na.rm=TRUE))) %>%
  tidyr::pivot_longer(cols=selCols, 
                      names_to="Parameter", values_to="Anzahl") %>%
  dplyr::mutate(Parameter = factor(Parameter, levels=selCols, labels=selCols, ordered=TRUE)) %>%
  dplyr::rename(Wave2=Date) %>%
  dplyr::mutate(Wave4=Wave2-days(daysDiff42)) %>%
  tidyr::pivot_longer(cols=c(Wave2, Wave4), values_to="Date", names_to="Wave")
# str(dp)

ggplot(data=dp, aes(x=Date, y=Anzahl, color=Wave)) +
  scale_x_datetime(name="2. Welle 8/2020", limits=c(as.POSIXct("2020-08-01"),as.POSIXct("2020-12-15")),  date_breaks="months", date_labels="%b",
                   sec.axis=sec_axis(name="4. Welle 7/2021", trans = (~ . +hms::hms(days=daysDiff42)))) +
  scale_y_continuous(name="Prozent(max)", trans="log2", limits=c(1/256,1), breaks=round(2^(seq(-8,0,by=1)),3),
                     sec.axis=dup_axis(name="Prozent_Stufe = log2(Prozent(max))", labels=seq(-8,0,by=1))) +
  geom_line(size=1) +
  facet_wrap(Parameter~., nrow=2) +
  ggtitle("COVID-19 Österreich: Vergleich 2. und 4. Welle mittels Überlagerung der Werte relativ zum Maximum der 2. Welle")

``` 