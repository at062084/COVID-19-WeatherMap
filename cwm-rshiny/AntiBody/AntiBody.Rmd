---
title: "COVID-19: Impfung und Antikörper Messung"
author: Thomas Strehl  https://www.linkedin.com/in/strehl-thomas-122867110
date: "2021-09-21"
output:
  pdf_document:
    fig_height: 6
    fig_width: 8
    number_sections: yes
    toc: yes
    toc_depth: 2
geometry: margin=1cm
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
knitr::opts_chunk$set(fig.align="center")
library(ggplot2)
library(dplyr)
library(tidyr)
```

\newpage
# COVID-19: Impfungen und Messung der Antikörper

Dieses Dokument beschreibt anhand zweier Testpersonen den zeitlichen Verlauf der COVID-19 Impfungen und die Ergebnisse einer Reihe von IgG Antikörper Tests. Die Daten umfassen

- Zeitreihen von 2 Pesonen (M, W, beide Altersgruppe 55-65)
- Je zwei Impfungen (Serie1: W=AstraZeneca, Serie 2: M=BiontecPfizer)
- Mehrmalige Messung der Antikörper (Einheit BAU/ml, IgG, einschl. neutralisierende AK gegen Spike RBD der S1-Untereinheit des Spike-Proteins von SARS-CoV-2, durchgeführt bei SYNLAB/IMCL)



```{r}
df <- read.csv("AntiBody.csv")
df$Datum <- as.POSIXct(as.character(df$Datum))
df$ID <- factor(df$ID)

# Exctract date for 'ZweiteImpfung
di <- df %>% dplyr::filter(ImpfStatus=="ZweiteImpfung", Aktion=="Impfung") %>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(DatumZweiteImpfung=Datum) %>%
  dplyr::select(ID, DatumZweiteImpfung)

# Calculate new TimeScale based on DatumZwiteImpfung 
df <- df %>%
  dplyr::left_join(di) %>%
  dplyr::group_by(ID) %>%
  dplyr::mutate(Monat = as.numeric((Datum-DatumZweiteImpfung)/3600/24/30)) %>%
  dplyr::ungroup()

```


```{r}
# Regression Models
Monat=seq(0,12,by=.1)

ds1 <- df %>% dplyr::filter(ImpfStoff=="BiontecPfizer", ImpfStatus=="ZweiteImpfung", Aktion=="AntiKörper")
lm1 <- lm(formula=log2(Wert)~Monat, data=ds1)
pred1 <- 2^predict(lm1, newdata=data.frame(Monat=Monat))
dp1 <- data.frame(Monat=Monat, Wert=pred1, ImpfStoff="BiontecPfizer")
```


```{r}
ds2 <- df %>% dplyr::filter(ImpfStoff=="AstraZeneca", ImpfStatus=="ZweiteImpfung", Aktion=="AntiKörper")
lm2 <- lm(formula=log2(Wert)~Monat, data=ds2)
pred2 <- 2^predict(lm2, newdata=data.frame(Monat=Monat))
dp2 <- data.frame(Monat=Monat, Wert=pred2, ImpfStoff="AstraZeneca")
```


## Zeitlicher Verlauf der Impfungen und Antikörper Werte

In der folgenden Darstellung sind die Zeitreihen der Antikörper Messungen der beiden Testpersonen dargestellt. 

- Die Zeitachsen der beiden Verläufe sind auf den Zeitpunkt der zweiten Impfung syncronisiert
- Zeitpunkte vor der zweiten Impfung haben negative Werte
- Die Einheit der Werte auf der y-Achse sind BAU/ml
- Die maximal erreichten Werte liegen bei Testperson W mit AstraZeneca bei 550
- Die maximal erreichten Werte liegen bei Testperson M mit BiontecPfizer bei 1800

In beiden Fällen nehmen die Werte mit der Zeit in etwa exponentiell ab (Für TestPerson W mit AstraZeneca wäre rein mathematisch auch eine lineare Abnahme möglich, aber aus medizinischen Gründen wenig wahrscheinlich)

```{r}
ggplot(data=df %>% dplyr::filter(Aktion=="AntiKörper"), aes(x=Monat, y=Wert, shape=ImpfStatus, color=ImpfStatus, group=ImpfStatus)) +
  scale_x_continuous(limit=c(-3.1,9), breaks=-3:9, sec.axis=dup_axis()) +
  scale_y_continuous(limit=c(-50,2000), breaks=seq(0,1900,by=100), sec.axis=dup_axis(), expand=c(0.0,0.0)) +
  geom_vline(data=df %>% dplyr::filter(Aktion=="Impfung"), aes(xintercept=Monat, color=ImpfStatus), size=2) +
  geom_point(size=3, color="blue") + 
  geom_line(size=1) +
  facet_grid(ImpfStoff~.) +
  geom_line(data=dp1, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  geom_line(data=dp2, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  ggtitle("Vacination and AntiBody Test results: 2 Samples (AgeGroup 55-65, M and W), \nExponential Model, BAU/ml units")
```
\newpage
## Exponentielle Abnahme der Antiköper Werte

Die These einer exponentiellen Abnahme der Antikörper Messwerte mit der Zeit lässt sich durch eine logarithmische Darstellung verifizieren. 

- In dieser Darstellung sollten die Werte linear abnehmen, d.h. auf einer Geraden liegen
- Die Beschriftung der y-Achse ist so gewählt, dass jede Skalenstufe eine Verdoppelung bzw. Halbierung der Antikörper Messwerte anzeigt

Die Halbwertszeit, d.h. die Dauer bis zu einer Halbierung der Messwerte,  ist

- 60 Tage (2.0 Monate) für TestPerson W mit AstraZeneca
- 35 Tage (1.2 Monate) für TestPerson M mit BiontecPfizer

Trotz wesentlich höherer Maximalwerte bei Testperson M mit BiontecPfizer sind die Antikörper bereits nach ca. 10 Monaten nicht mehr nachweisbar sein werden. Bei TestPerson W mit AstraZeneca sind die maximalen Antikörperwerte vergleichsweise niedrig, nehmen aber wesentlich langsamer ab, sodass der Nachweis erst nach etwas über einem Jahr nicht mehr möglich sein wird.

**Anmerkung:** Die Prognosen für die Antikörper Werte sind bestenfalls erste Anhaltspunkte und müssen durch fortgesetzte Messungen an den beiden (sowie weiteren) Testpersonen präzisiert werden.


```{r}
ggplot(data=df %>% dplyr::filter(Aktion=="AntiKörper"), aes(x=Monat, y=Wert, shape=ImpfStatus, color=ImpfStatus, group=ImpfStatus)) +
  scale_x_continuous(limit=c(-3.1,12), breaks=-3:12, sec.axis=dup_axis()) +
  scale_y_continuous(limit=c(10,2000), breaks=2^seq(0:12), sec.axis=dup_axis(), trans="log2") +
  geom_vline(data=df %>% dplyr::filter(Aktion=="Impfung"), aes(xintercept=Monat, color=ImpfStatus), size=2) +
  geom_point(size=3, color="black") + 
  geom_line() +
  facet_grid(ImpfStoff~.) +
  geom_line(data=dp1, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  geom_line(data=dp2, aes(x=Monat, y=Wert), inherit.aes=FALSE, linetype=3) +
  ggtitle("Vacination and AntiBody Test results: 2 Samples (AgeGroup 55-65, M and W), \nExponential Model, logScale y, BAU/ml units for half/double")
```




\newpage
# Technische Details

## DatenStruktur

```{r}
str(df)
```

## Daten

```{r}
df %>% select(ID, Alter, Geschlecht, Datum, ImpfStatus, ImpfStoff, Aktion, Wert)
```

\newpage
## Exponentielles Modell

### TestPerson 1

```{r}
summary(lm1)
(HalbwertsZeit = -1/coef(lm1)[2])

```

### TestPerson 2

```{r}
summary(lm1)
(HalbwertsZeit = -1/coef(lm1)[2])
  
```




